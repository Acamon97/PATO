import sys
import os
import pandas as pd
from collections import defaultdict

# Agregar el directorio padre al path para importar NLU.py
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from NLU import NLU

nlu = NLU(models_path="D:\MASTER\PATO\models")

test_intents = {
    "Adi√≥s" : "despedir",
    "Hasta pronto, pato" : "despedir",
    "Ya me voy, hablamos luego" : "despedir",
    "Muchas gracias por todo, nos vemos m√°s tarde" : "despedir",
    "Gracias por la ayuda, hasta otra" : "despedir",
    "Pato, ya puedes descansar" : "despedir",
    "Ciao, amigo pato" : "despedir",
    "Hablamos otro d√≠a, cu√≠date" : "despedir",
    "Pato, ap√°gate y descansa" : "despedir",
    "Nos vemos en la pr√≥xima conversaci√≥n" : "despedir",
    "Ya es tarde, mejor dejo esto por ahora, hasta luego" : "despedir",
    "Termin√© por hoy, gracias y adi√≥s" : "despedir",
    "Me despido, seguimos otro d√≠a" : "despedir",

    "Termina esta conversaci√≥n" : "terminar_conversacion",
    "Pato, para la conversaci√≥n" : "terminar_conversacion",
    "Apaga el chat, ya no quiero seguir" : "terminar_conversacion",
    "Det√©n el di√°logo, no quiero m√°s respuestas" : "terminar_conversacion",
    "Cierra esto, ya no es necesario" : "terminar_conversacion",
    "Fin del tema, no m√°s interacci√≥n" : "terminar_conversacion",
    "Pato, ya puedes detenerte" : "terminar_conversacion",
    "Corta la comunicaci√≥n, no sigas hablando" : "terminar_conversacion",
    "Pato, para ya, necesito silencio" : "terminar_conversacion",
    "Ya acabamos, deja de responder" : "terminar_conversacion",
    "Finaliza esta charla, hemos terminado" : "terminar_conversacion",
    "Quiero cerrar este tema y seguir otro d√≠a" : "terminar_conversacion",
    "No hables m√°s, termina aqu√≠" : "terminar_conversacion",

    "Quiero empezar de nuevo" : "reiniciar_conversacion",
    "Pato, olvida todo lo que hemos hablado" : "reiniciar_conversacion",
    "Reinicia el contexto de la conversaci√≥n" : "reiniciar_conversacion",
    "Borra todo y volvamos a empezar" : "reiniciar_conversacion",
    "Resetea la charla y empecemos otra vez" : "reiniciar_conversacion",
    "Borr√≥n y cuenta nueva, empecemos desde cero" : "reiniciar_conversacion",
    "Vamos a intentarlo otra vez, pero desde el principio" : "reiniciar_conversacion",
    "Pato, necesito empezar otra vez, sin recordar lo anterior" : "reiniciar_conversacion",
    "Necesito un nuevo comienzo en esta charla" : "reiniciar_conversacion",
    "Elimina el historial y dime que puedo hacer ahora" : "reiniciar_conversacion",
    "Reinicia tus datos de conversaci√≥n y dime algo nuevo" : "reiniciar_conversacion",
    "Quiero que empieces de cero, sin contexto previo" : "reiniciar_conversacion",

    "Mu√©strame todos los comandos posibles" : "mostrar_comandos",
    "Qu√© funciones puedo activar contigo?" : "mostrar_comandos",
    "Dame una lista de √≥rdenes v√°lidas" : "mostrar_comandos",
    "Pato, dime c√≥mo puedo controlarte" : "mostrar_comandos",
    "¬øC√≥mo interact√∫o contigo con comandos?" : "mostrar_comandos",
    "Dame un resumen de los comandos que entiendes" : "mostrar_comandos",
    "Expl√≠came qu√© puedo hacer con comandos" : "mostrar_comandos",
    "Necesito saber qu√© √≥rdenes puedes ejecutar" : "mostrar_comandos",
    "Quiero saber las instrucciones para manejar la conversaci√≥n" : "mostrar_comandos",
    "Qu√© comandos tengo disponibles para manejar la charla?" : "mostrar_comandos",
    "Pato, dime todas las funciones que puedo usar contigo" : "mostrar_comandos",

    "Pausa esto por un momento" : "pausar_conversacion",
    "Pato, qu√©date en silencio unos minutos" : "pausar_conversacion",
    "Pon en espera la charla" : "pausar_conversacion",
    "Necesito hacer algo, detente un momento" : "pausar_conversacion",
    "Haz una pausa en la conversaci√≥n y espera" : "pausar_conversacion",
    "Guarda silencio hasta que te diga que sigas" : "pausar_conversacion",
    "No respondas por ahora, solo espera" : "pausar_conversacion",
    "D√©jame concentrarme, no hables por un rato" : "pausar_conversacion",
    "Necesito un respiro, pon esto en pausa" : "pausar_conversacion",
    "Luego seguimos, mant√©n esto pausado" : "pausar_conversacion",

    "Sigamos donde lo dejamos" : "continuar_conversacion",
    "Contin√∫a con la conversaci√≥n" : "continuar_conversacion",
    "Retoma lo √∫ltimo que me estabas diciendo" : "continuar_conversacion",
    "Puedes seguir con el tema anterior" : "continuar_conversacion",
    "Perd√≥n, tuve que irme, dime qu√© dec√≠as" : "continuar_conversacion",
    "Estoy de vuelta, seguimos?" : "continuar_conversacion",
    "No recuerdo qu√© dec√≠as antes, puedes repetir?" : "continuar_conversacion",
    "Quiero continuar con lo que habl√°bamos antes" : "continuar_conversacion",
    "Retomemos esto desde el punto en que lo dejamos" : "continuar_conversacion",
    "Dime en qu√© hab√≠amos quedado" : "continuar_conversacion",

    "Pato, qu√© opinas de la inteligencia artificial?" : "nlu_fallback",
    "Me recomiendas comprar un coche el√©ctrico?" : "nlu_fallback",
    "Oye, qu√© piensas sobre la filosof√≠a del estoicismo?" : "nlu_fallback",
    "Dime algo interesante sobre el universo" : "nlu_fallback",
    "C√≥mo preparo una pizza en casa?" : "nlu_fallback",
    "Qu√© temperatura har√° ma√±ana en Madrid?" : "nlu_fallback",
    "Pato, cu√°l es la mejor pel√≠cula de ciencia ficci√≥n?" : "nlu_fallback",
    "Cu√©ntame un chiste, quiero re√≠rme un poco" : "nlu_fallback",
    "Quiero hablar sobre pol√≠tica, qu√© opinas?" : "nlu_fallback",
    "Necesito ayuda con matem√°ticas, cu√°nto es 25 x 8?" : "nlu_fallback",
    "Hola PATO buenos dias, ¬øc√≥mo estas?" : "nlu_fallback",

    "A√±adir tarea comprar pan" : "nlu_fallback",
    "Agrega una nueva tarea: llamar al m√©dico" : "nlu_fallback",
    "Quiero que registres la tarea de revisar correos" : "nlu_fallback",
    "Anota la tarea de pagar la factura de la luz" : "nlu_fallback",
    "Pato, apunta 'revisar informe mensual' en la lista de tareas" : "nlu_fallback",
    "Agr√©game 'llevar el coche al taller' como una tarea pendiente" : "nlu_fallback",
    "Crea una tarea para hacer ejercicio a las 6pm" : "nlu_fallback",
    "Toma nota: 'terminar presentaci√≥n para el viernes'" : "nlu_fallback",
    "Pon en mi lista de tareas: 'comprar regalo para mam√°'" : "nlu_fallback",
    "Apunta esto: 'estudiar para el examen de matem√°ticas'" : "nlu_fallback",

    "¬øQu√© tareas tengo pendientes?" : "nlu_fallback",
    "Mu√©strame mi lista de tareas" : "nlu_fallback",
    "¬øCu√°les son mis pr√≥ximas tareas?" : "nlu_fallback",
    "Dime qu√© cosas tengo por hacer hoy" : "nlu_fallback",
    "Ens√©√±ame la lista de tareas activas" : "nlu_fallback",
    "Pato, dime qu√© pendientes tengo" : "nlu_fallback",
    "¬øCu√°ntas tareas sin completar tengo?" : "nlu_fallback",
    "Quiero ver las tareas que a√∫n no he hecho" : "nlu_fallback",
    "Recu√©rdame qu√© cosas ten√≠a anotadas para hoy" : "nlu_fallback",
    "Lista todas mis tareas, por favor" : "nlu_fallback",

    "Borra la tarea de comprar pan" : "nlu_fallback",
    "Elimina la tarea que dice 'revisar informe mensual'" : "nlu_fallback",
    "Pato, quiero borrar 'llamar al m√©dico' de mi lista" : "nlu_fallback",
    "Quiero quitar la tarea de hacer ejercicio" : "nlu_fallback",
    "Borra todas las tareas que ya no sean importantes" : "nlu_fallback",
    "Elimina la √∫ltima tarea que agregu√©" : "nlu_fallback",
    "¬øPuedes eliminar la tarea de pagar la luz?" : "nlu_fallback",
    "Ya no necesito la tarea de 'comprar regalo', b√≥rrala" : "nlu_fallback",
    "Pato, elimina la tarea con el nombre 'estudiar para examen'" : "nlu_fallback",

    "Borra las tareas completadas" : "nlu_fallback",
    "Marca como completada la tarea de comprar pan" : "nlu_fallback",
    "Ya termin√© 'llamar al m√©dico', m√°rcala como hecha" : "nlu_fallback",
    "Tarea 'hacer ejercicio' completada, actualiza mi lista" : "nlu_fallback",
    "Pato, marca la tarea de revisar correos como hecha" : "nlu_fallback",
    "Acabo de terminar la tarea de pagar la factura, reg√≠strala como completada" : "nlu_fallback",
    "Ya hice todo lo de la presentaci√≥n, actualiza mi lista" : "nlu_fallback",
    "Marca como hecha la tarea 'llevar el coche al taller'" : "nlu_fallback",
    "Termin√© la tarea de comprar el regalo, ¬øpuedes actualizar mi lista?" : "nlu_fallback",
    "Quiero que marques como finalizada la tarea de 'estudiar para examen'" : "nlu_fallback",
    "Pato, confirma que he completado la √∫ltima tarea que agregu√©" : "nlu_fallback",

    "¬øQu√© tareas ya he completado?" : "nlu_fallback",
    "Mu√©strame la lista de tareas terminadas" : "nlu_fallback",
    "Quiero ver las tareas que ya he hecho" : "nlu_fallback",
    "¬øCu√°les son las tareas que ya complet√©?" : "nlu_fallback",
    "Dame un resumen de mis tareas finalizadas" : "nlu_fallback",
    "Pato, ens√©√±ame las cosas que ya termin√©" : "nlu_fallback",
    "¬øCu√°ntas tareas he logrado completar hasta ahora?" : "nlu_fallback",
    "Recu√©rdame las tareas que ya marqu√© como hechas" : "nlu_fallback",
    "Quiero ver las tareas cerradas" : "nlu_fallback",
    "Lista las √∫ltimas cinco tareas que complet√©" : "nlu_fallback"
}

# üìå Variables para an√°lisis de errores
errores_por_intent = defaultdict(int)
aciertos_por_intent = defaultdict(int)
errores_detallados = []

def test_nlu():
    """Prueba la detecci√≥n de intents con Rasa NLU y analiza los errores."""
    print("\nüìå INICIANDO TEST DE NLU")
    total_tests = len(test_intents)
    errores = 0

    for frase, intent_esperado in test_intents.items():
        print(f"\nüîç Probando NLU con: \"{frase}\"")

        intent_detectado = nlu.detectar_intent(frase)

        if intent_detectado is None:
            intent_detectado = "nlu_fallback"

        # üìå Registro de aciertos y errores por intent
        if intent_detectado == intent_esperado:
            aciertos_por_intent[intent_esperado] += 1
            print(f"‚úÖ Intent detectado correctamente: {intent_detectado}")
        else:
            errores_por_intent[intent_esperado] += 1
            errores += 1
            errores_detallados.append([frase, intent_esperado, intent_detectado])
            print(f"‚ùå ERROR: Se esperaba \"{intent_esperado}\", pero se detect√≥ \"{intent_detectado}\"")

    # üìä Resultados finales
    print("\nüìä RESULTADOS GLOBALES:")
    print(f"üîπ Precisi√≥n total: {((total_tests - errores) / total_tests) * 100:.2f}%")
    print(f"‚ùå Total de errores: {errores} / {total_tests}")

    # üìä An√°lisis de errores por intent
    print("\nüìä ERRORES POR INTENT:")
    for intent, count in errores_por_intent.items():
        total_tests_intent = errores_por_intent[intent] + aciertos_por_intent[intent]
        precision = (aciertos_por_intent[intent] / total_tests_intent) * 100 if total_tests_intent > 0 else 0
        print(f"‚ùå {intent}: {count} errores | Precisi√≥n: {precision:.2f}%")

    # üìÇ Guardar reporte de errores en CSV
    df_errores = pd.DataFrame(errores_detallados, columns=["Frase", "Intent esperado", "Intent detectado"])
    df_errores.to_csv("test_nlu_errores.csv", index=False, encoding="utf-8")
    print("\nüìÇ Reporte de errores guardado en 'test_nlu_errores.csv'")

if __name__ == "__main__":
    test_nlu()